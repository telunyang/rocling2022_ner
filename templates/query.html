<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>crowNER 預測結果檢視頁面</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <!-- jQuery UI -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <!-- 自訂 -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand mx-3" href="#">crowNER 預測結果檢視頁面</a>
    </nav>

    <main role="main" class="container">
        <div class="row mb-3">
            <div class="col-md-8 col-sm-8">
                <button class="btn btn-secondary" type="submit" id="btn_query">Predict</button>
            </div>
            <div class="col-auto">
                本次查詢時間：<span class="badge bg-secondary" id="exec_secs"></span> 秒
            </div>
        </div>
        <div class="row mb-3">
            <div class="col">
                <textarea class="form-control" type="text" placeholder="請輸入一或多個句子，每個句子用斷行來區隔" id="search_bar"></textarea>
            </div>
        </div>
        <div class="row">
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th class="w-25">流水號</th>
                        <th class="w-auto">結果</th>
                    </tr>
                </thead>
                <tbody id="result"></tbody>
            </table>
        </div>
        </form>
    </main><!-- /.container -->

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- jQuery UI -->
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <!-- jQuery blockUI -->
    <script src="js/jquery.blockUI.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!-- Font Awesome -->
    <script defer src="https://pro.fontawesome.com/releases/v5.10.0/js/all.js"
        integrity="sha384-G/ZR3ntz68JZrH4pfPJyRbjW+c0+ojii5f+GYiYwldYU69A+Ejat6yIfLSxljXxD"
        crossorigin="anonymous"></script>

    <!-- 自訂 JS -->
    <script>
    // 送出查詢
    $(document).on('click', 'button#btn_query', function (event) {
        event.preventDefault();

        //設定時間變數
        timeStart = timeEnd = 0

        //計算開始時間
        timeStart = Date.now() / 1000

        //取得文字並要求輸入字數
        let sentences = $('textarea#search_bar').val();
        if (sentences.length === 0) { alert('請輸入文字'); return false; }

        //取得 tbody 元素
        let tbody_result = $('tbody#result');

        //預設彈跳訊息
        let html_msg = `<h1 id="msg">請稍候</h1>`

        //浮現 blockUI
        $.blockUI({ 
            message: html_msg, 
            css: { 
                border: 'none', 
                padding: '15px', 
                backgroundColor: '#000', 
                '-webkit-border-radius': '10px', 
                '-moz-border-radius': '10px', 
                opacity: .5, 
                color: '#fff' 
            }
        });

        //查詢文字
        $.post(`./predict`, { sentences: sentences }, (obj) => {
            //
            if( !obj['success'] ){ alert(`${obj['info']}`); return false; }

            //清空 tbody 內文
            tbody_result.html('');
            
            //整合查詢結果
            let sn = 1
            for (let arr of obj['results']) {
                // 整合 html 資料
                let html = ``;
                for(let o of arr){
                    for(let char in o){
                        if( o[char] == 'O' ){
                            html += `${char}`;
                        } else {
                            html += `<mark data-entity="${o[char]}">${char}</mark>`;
                        }
                    }
                }
                tbody_result.append(`<tr>
                    <th scope="row">${sn}</th>
                    <td class="entities">${html}</td>
                </tr>`);

                //流水號遞增
                sn++;
            }

            // 關閉 blockUI
            $.unblockUI();

            //計算結束時間
            timeEnd = Date.now() / 1000

            // //計算執行花費時間，顯示結果
            // let div_msg = document.getElementById('liveToast');
            // div_msg.querySelector('div.toast-body').innerText = `執行時間: ${timeEnd - timeStart} 秒`
            // let toast = new bootstrap.Toast( div_msg );
            // toast.show();

            //執行花費時間顯示在按鈕旁邊
            $('span#exec_secs').text(`${timeEnd - timeStart}`);
        });
    });
    </script>


    <!-- toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
        <div class="toast-header">
            <!-- <img src="..." class="rounded me-2" alt="..."> -->
            <strong class="me-auto">訊息</strong>
            <!-- <small>11 mins ago</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> -->
        </div>
        <div class="toast-body"></div>
        </div>
    </div>
</body>

</html>